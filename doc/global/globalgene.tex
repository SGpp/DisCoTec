\documentclass[12pt]{report}
\usepackage{a4wide}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{lscape}
\newcommand{\bea}{\begin{eqnarray}}
\newcommand{\eea}{\end{eqnarray}}
\newcommand{\abs}[1]{\left| #1 \right|}
\newcommand{\avg}[1]{\left\langle #1 \right\rangle}
\newcommand{\tavg}[1]{\left\langle #1 \right\rangle_{\!\!t}}
\newcommand{\nperp}{\nabla\!\!_\bot}
\renewcommand{\div}{\mbox{div}\,}
\newcommand{\gene}{{\sc Gene}\,}
\newcommand{\dx}{\Delta x}
\newcommand{\sgn}{\mbox{sgn}\,}
\newcommand{\diag}{\mbox{diag}\,}
\newcommand{\rf}{\mathrm{ref}} %index for reference values in math mode
\newcommand{\nn}{\nonumber}

%apply on values which are species dependent normalizations
\newcommand{\refj}[2][j]{#2_{\rf,#1}} 

%species dependent profiles normalized to Tref,j
\newcommand{\Tpj}{\hat{T}_{j,x}}
\newcommand{\npj}{\hat{n}_{j,x}} 
\newcommand{\omT}{\omega _{Tj,x}}
\newcommand{\omn}{\omega _{nj,x}}

%\includeonly{gg_numerics,gg_derivation}
%\includeonly{gg_numerics}

%some other command definition used in gg_derivation
%commands definitions

\def\vpar{v_\parallel}
\def\d{\partial}
\def\D{{\rm d}}
\newcommand{\pderiv}[2]{\frac{\partial #1}{\partial #2}}
\def\b{\mathbf{b}}
\def\vE{\mathbf{v_E}}
\def\vgB{\mathbf{v_{\nabla B}}}
\def\vc{\mathbf{v_c}}
\def\Bs{B_{0 \parallel} ^*}
\newcommand{\mb}{\mathbf}
\newcommand{\h}{\hat}
\def\ra{\rightarrow}
\newcommand{\kymin}{k_y^{\rm min}}
\newcommand{\rhoref}{\rho_{\rm ref}}
% normalisation
\def\Br{B_{\mbox{\small ref\,}}}
\def\rhor{\rho_{\mbox{\small ref\,}}}
\def\crf{c _{\mbox{\small ref\,}}}
\def\wr{\Omega _{\mbox{\small ref\,}}}
\def\mr{m _{\mbox{\small ref\,}}}
\def\nr{n _{\mbox{\small ref\,}}}
\def\Tr{T _{\mbox{\small ref\,}}}
\def\qr{q _{\mbox{\small ref\,}}}
\def\pr{p _{\mbox{\small ref\,}}}
\def\Lp{L _{\perp\,}}
% derivative
\def\dx{\d _{x \,}}
\def\dy{\d _{y \,}}
\def\dz{\d _{z \,}}
\def\dfdv{\frac{\d f_1}{\d \vpar}}
\def\dchida{\frac{\d \chi_1}{\d \alpha}}
\def\dchidb{\frac{\d \chi_1}{\d \beta}}
\def\dfoda{\frac{\d f _0}{\d \alpha}}
\def\dfodv{\frac{\d f _0}{\d \vpar}}
\def\G{\mathbf{\mathcal{G}}}
\def\Kx{\mathcal{K}_x}
\def\Ky{\mathcal{K}_y}
\def\C{\mathcal{C}}
\def\cofac{\C\,}
\def\spec{j}
\newcommand{\xp}{x_0}		%radial reference position for profiles
\newcommand{\roL}{\frac{\rho_\rf}{L_\rf}} % rho_ref/L_ref = _r_ho _o_ver _L_
\newcommand{\mvec}[1]{\mathbf{#1}}                 %my vec


\title{Developer's manual for the global version of the GENE code}
\author{S.~Brunner, T.~Dannert, X.~Lapillonne\\Ecole Polytechnique
  F\'ed\'erale de Lausanne\\Centre de Recherches en Physique des
  Plasmas\\1015 Lausanne, Switzerland \and T.~G\"orler, F.~Jenko,
  F.~Merz, D.~Told\\Max-Planck Institut f\"ur
  Plasmaphysik\\Boltzmannstr. 2\\85748 Garching}


\begin{document}
\maketitle
\tableofcontents

\include{gg_derivation}
\include{gg_numerics}
\include{gg_sources}

\include{gg_coding}
\appendix
\chapter{Standard coordinate systems}

\section{Cartesian coordinates $x,y,z$}
First we start with a Cartesian  system, where the metric tensor it just the
unit matrix. With the usage of $x^1=x_1=x$, $x^2=x_2=y$ and $x^3=x_3=z$, we arrive at the Lagrangian
\begin{displaymath}
  L(\mathbf{x},\mathbf{v}) =
  mv_j\dot x^j
  +\frac{e}{c}A_j(\mathbf{x})\dot x^j
  -\frac{m}{2}v_jv^j
  -e\Phi(\mathbf{x})
\end{displaymath}
and the equations of motions
\begin{eqnarray*}
  m\dot v_r &=&
  \frac{e}{c}\left[
    \partial_rA_j
    -\partial_jA_r
  \right]\dot x^j
  -e\partial_r\Phi\\
  \dot x_r &=& v_r
\end{eqnarray*}


\section{Cylindrical coordinates $r,\varphi,z$}
First we have to calculate the metric tensor of a cylindrical coordinate
system. This task is to be done with explicitly writing down the
transformation equations from a cartesian to a cylindrical system and then
calculate the metric tensor out of this transformation equations.
The transformation is done with
\begin{eqnarray*}
  x^1=r=\sqrt{x^2+y^2}\qquad x^2=\varphi=\arctan\frac{y}{x}\qquad x^3=z=z
\end{eqnarray*}
For the unit vectors in the three directions we get
\begin{eqnarray*}
  \mathbf{e}^1&=&\nabla x^1
  =\frac{\partial x^1}{\partial x}\nabla x
  +\frac{\partial x^1}{\partial y}\nabla y
  +\frac{\partial x^1}{\partial z}\nabla z
  =\frac{x}{r}\mathbf{e}^x+\frac{y}{r}\mathbf{e}^y\\
  \mathbf{e}^2&=&\nabla x^2
  =\frac{\partial x^2}{\partial x}\nabla x
  +\frac{\partial x^2}{\partial y}\nabla y
  +\frac{\partial x^2}{\partial z}\nabla z
  =-\frac{y}{r^2}\mathbf{e}^x+\frac{x}{r^2}\mathbf{e}^y\\
  \mathbf{e}^3&=&\nabla x^3=\mathbf{e}^z
\end{eqnarray*}
From this we get the components of the metric tensor as
\begin{eqnarray*}
  g^{11} &=& \mathbf{e}^1\cdot\mathbf{e}^1
  =\left(\frac{x}{r}\mathbf{e}^x+\frac{y}{r}\mathbf{e}^y\right)
  \cdot\left(\frac{x}{r}\mathbf{e}^x+\frac{y}{r}\mathbf{e}^y\right)
  =\frac{x^2}{r^2}+\frac{y^2}{r^2}=1\\
  g^{12} &=& \mathbf{e}^1\cdot\mathbf{e}^2=0\\
  g^{13} &=& \mathbf{e}^1\cdot\mathbf{e}^3=0\\
  g^{22} &=& \mathbf{e}^2\cdot\mathbf{e}^2
  =\left(-\frac{y}{r^2}\mathbf{e}^x+\frac{x}{r^2}\mathbf{e}^y\right)\cdot
  \left(-\frac{y}{r^2}\mathbf{e}^x+\frac{x}{r^2}\mathbf{e}^y\right)
  =\frac{y^2+x^2}{r^4}=\frac{1}{r^2}\\
  g^{23} &=& \mathbf{e}^2\cdot\mathbf{e}^3=0\\
  g^{33} &=& \mathbf{e}^3\cdot\mathbf{e}^3=1
\end{eqnarray*}

Having the metric tensor, we also have its inverse
\begin{displaymath}
  (g_{ij})=\left(
    \begin{array}{ccc}
      1 & 0 & 0\\0 & r^2 & 0\\ 0 & 0 & 1
    \end{array}
  \right)
\end{displaymath}
The Lagrangian is independent of the choice of the coordinate system, so it is
still
\begin{displaymath}
  L(x,\dot x) =
  \frac{m}{2}\dot x_j\dot x^j
  +\frac{e}{c}A_j(\mathbf{x})\dot x^j
  -e\Phi(\mathbf{x})
\end{displaymath}
The equations of motion are 
\begin{eqnarray*}
  \ddot r
  &=& r(\dot \varphi)^2
  +\frac{e}{mc}r\left[
    B^3\dot \varphi
    -B^2\dot z
  \right]
  -\frac{e}{m}\frac{\partial \Phi(x)}{\partial r}\\
  r^2\ddot \varphi
  &=& -2r\dot \varphi\dot r
  +\frac{e}{mc}r\left[
    B^1\dot z
    -B^3\dot r
  \right]
  -\frac{e}{m}\frac{\partial \Phi(x)}{\partial \varphi}\\
  \ddot z
  &=&\frac{e}{mc}r\left[
    B^2\dot r
    -B^1\dot \varphi
  \right]
  -\frac{e}{m}\frac{\partial \Phi(x)}{\partial z}
\end{eqnarray*}

As an example, we make the assumption of a constant magnetic field
along the $z$ axis. So we use  $A_1=A_3=0$ and $A_2=Br^2/2$ in the
Lagrangian and get
\begin{displaymath}
  L(x,\dot x) =
  \frac{m}{2}(\dot r^2+r^2\dot\varphi^2+\dot z^2)
  +\frac{eB}{2c} r^2\dot \varphi
\end{displaymath}
With this ansatz, we see directly that $z$ and $\varphi$ are cyclic
variables. 


\section{Toroidal coordinate system}
\label{sec:torsys}
This subsection is only introduced to have a place where I can
calculate what I need for the description of this widely used
coordinate system. The coordinates are the radial coordinate $r$, the
poloidal angle $\theta$ and the toroidal angle $\phi$. The
transformation equations from the cylindrical system $(R,\phi_c,Z)$
are given by
\begin{displaymath}
  x^1=r=\sqrt{(R-R_0)^2+Z^2}
  \qquad x^2=\theta=\arctan\frac{Z}{R-R_0}
  \qquad x^3=\phi=-\phi_c
\end{displaymath}
From these equations one can easily get the new unit vectors
\begin{eqnarray*}
  \nabla r&=&\frac{\partial r}{\partial R}\nabla R
  +\frac{\partial r}{\partial Z}\nabla Z\\
  &=&\frac{R-R_0}{\sqrt{(R-R_0)^2+Z^2}}\nabla R
  +\frac{Z}{\sqrt{(R-R_0)^2+Z^2}}\nabla Z
  =\frac{R-R_0}{r}\nabla R+\frac{Z}{r}\nabla Z\\
                                %
  \nabla \theta&=&\frac{\partial\theta}{\partial R}\nabla R
  +\frac{\partial\theta}{\partial Z}\nabla Z\\
  &=&-\frac{Z}{\left(Z^2+(R-R_0)^2\right)}\nabla R
  +\frac{1}{(R-R_0) \left(\frac{Z^2}{(R-R_0)^2}+1\right)}\nabla Z
  =-\frac{Z}{r^2}\nabla R
  +\frac{(R-R_0)}{r^2}\nabla Z\\
  \nabla\phi &=&-\nabla\phi_c
\end{eqnarray*}
From these base vectors, we can find the components of the metric
tensor by building scalar product of the base vectors.
\begin{eqnarray*}
  g^{11} &=& \nabla r\cdot\nabla r \\
  &=&\frac{(R-R_0)^2}{r^2}\nabla R\cdot\nabla R
  +\frac{Z(R-R_0)}{r^2}\nabla R\cdot\nabla Z
  +\frac{Z(R-R_0)}{r^2}\nabla Z\cdot\nabla R
  +\frac{Z^2}{r^2}\nabla Z\cdot\nabla Z
  = 1\\
  g^{12} &=& 0\\
  g^{13} &=& 0\\
  g^{23} &=& 0\\
  g^{22} &=& \frac{1}{r^2}\\
  g^{33} &=& \tilde{g}^{22}=\frac{1}{R^2}=\frac{1}{(R_0+r\cos\theta)^2}
\end{eqnarray*}
The metric tensor for the covariant components is then the inverse
\begin{displaymath}
  g_{ij}=\left(
    \begin{array}{ccc}
      1 & 0 & 0\\
      0 & r^2 & 0\\
      0 & 0 & R^2
    \end{array}\right)
\end{displaymath}
The Jacobian in this coordinate system is then
\begin{displaymath}
  J^{-1}=\sqrt{|g_{ij}|}=\sqrt{r^2R^2}=rR
\end{displaymath}

\section{Some characteristics of the magnetic field in an
  axisymmetric case}
\label{sec:charar_genBfield}

For the magnetic field, the homogeneous Maxwell equation must be
fulfilled. This equation can be written in the flux surface
coordinates as
\begin{eqnarray*}
  0&=&\div \mathbf{B}=\frac{1}{J(\rho,\theta)}\left(
    \frac{\partial}{\partial \rho} (JB^\rho)
    +\frac{\partial}{\partial \theta} (JB^\theta)
    +\frac{\partial}{\partial \phi} (JB^\phi)
  \right)\\
  &=&\frac{1}{J(\rho,\theta)}\left(
    \frac{\partial}{\partial \rho} (JB^\rho)
    +\frac{\partial}{\partial \theta} (JB^\theta)
  \right)
\end{eqnarray*}
This leads to the condition
\begin{displaymath}
  \frac{\partial}{\partial \rho} (JB^\rho)
  =-\frac{\partial}{\partial \theta} (JB^\theta)
\end{displaymath}
We can write the magnetic field also as
\begin{displaymath}
  \mathbf{B}=B^\rho\mathbf{e}_\rho+B^\theta\mathbf{e}_\theta
  +B^\phi\mathbf{e}_\phi
\end{displaymath}
But with the definition of $\rho$ as a flux surface label, we have 
\begin{displaymath}
  \mathbf{B}\cdot\nabla\rho=B^\rho=0
\end{displaymath}
which simplifies the above equations and we get for the magnetic field
\begin{displaymath}
  \mathbf{B}=B^\theta\mathbf{e}_\theta+B^\phi\mathbf{e}_\phi
\end{displaymath}
and from the divergence equation
\begin{displaymath}
  \frac{\partial}{\partial \theta} (JB^\theta)=0
\end{displaymath}
we find that $JB^\theta$ is also a flux surface function.

The magnetic field can further be written as
\begin{eqnarray*}
  \mathbf{B} &=& JB^\theta \mathbf{e}^\phi\times \mathbf{e}^\rho
  +JB^\phi \mathbf{e}^\rho\times\mathbf{e}^\theta\\
  &=& \nabla\rho\times\left(
    JB^\phi \nabla\theta
    -JB^\theta \nabla\phi
  \right)
\end{eqnarray*}
Now introducing a function $\nu(\rho,\theta,\phi)$ by the defining
equations
\begin{displaymath}
  \frac{\partial \nu}{\partial\theta}=JB^\phi
  \qquad  \frac{\partial \nu}{\partial\phi}=-JB^\theta
\end{displaymath}
we can write the magnetic field in the simple Clebsch form
\begin{displaymath}
  \mathbf{B}=\nabla\rho\times\nabla\nu
\end{displaymath}

\bigskip
For the function $\nu$ we can further process
\begin{eqnarray*}
  \frac{\partial \nu}{\partial\phi}=-JB^\theta=-f(\rho)
  \qquad\Longrightarrow\quad
  \nu(\rho,\theta,\phi) = -JB^\theta \phi+c_1(\rho,\theta)
\end{eqnarray*}
We know further that $JB^\phi$ is a physical quantity, so it must be
periodic in the both angles $\theta$ and $\phi$. From this we can
deduce that the dependence of $\nu$ on $\theta$ can only be of the
general form
\begin{displaymath}
  \nu(\rho,\theta,\phi)= -JB^\theta \phi+A(\rho)\theta+\tilde\nu(\rho,\theta)
\end{displaymath}
where $\tilde\nu(\rho,\theta)$ is a periodic function in $\theta$.
To find a physical expression for the prefactor $A(\rho)$, we can
write the toroidal flux function
\begin{eqnarray*}
  \psi_\mathrm{tor}(\rho)&=&\frac{1}{2\pi}\int_0^{2\pi}\int_0^{2\pi}\int_0^\rho JB^\phi\,d\rho'\,d\theta\,d\phi
  = \int_0^\rho\int_0^{2\pi} \frac{\partial\nu}{\partial\theta}\,d\theta\,d\rho'\\
  &=&\int_0^\rho (\nu(\rho',2\pi,\phi)-\nu(\rho',0,\phi))\,d\rho'
  = \int_0^\rho 2\pi A(\rho')\,d\rho'
\end{eqnarray*}
So we can write
\begin{displaymath}
  A(\rho) = \frac{\psi_\mathrm{tor}'}{2\pi} = \psi_t'
\end{displaymath}
This leads to the general form for axisymmetric magnetic field for the
generating function $\nu$
\begin{displaymath}
  \nu(\rho,\theta,\phi)=-JB^\theta \phi+\psi_t'(\rho)\theta+\tilde\nu(\rho,\theta)
\end{displaymath}
With the same thoughts as we did for the toroidal flux, we can find
for the poloidal flux the expression
\begin{displaymath}
  \psi_p'=\frac{\psi_\mathrm{pol}'}{2\pi}=JB^\theta
\end{displaymath}
so we can also write for $\nu$
\begin{displaymath}
  \nu(\rho,\theta,\phi)=\psi_t'\theta-\psi_p'\phi+\tilde\nu(\rho,\theta)
  =\psi_p'\left(
    q(\rho)\theta-\phi
  \right)+\tilde\nu(\rho,\theta)
\end{displaymath}


\section{Oblique angle coordinate system in two dimensions}
\label{sec:gengeom}

In this section, I will investigate some geometry related
problems. The first one arises, if one wants to do the gyroaveraging
in two dimensions, with one dimension Fourier transformed, as we do in
gene10. The problem is, that the twodimensional coordinate system, in
which we work, the $x$-$y$ coordinate system of the code is
non-orthogonal in general. This means that $g^{12}\neq0$. The question
is then, if and how one can do a Fourier transform in one direction and
treating the other direction by other methods. 

I start from a Cartesian system with the coordinates $x$ and $y$. It
is true
\begin{displaymath}
  x=x^1=x_1\qquad
  y=x^2=x_2\qquad
  \mathbf{e}^1=\nabla x = (1,0)^\top=\mathbf{e}_1\qquad
  \mathbf{e}^2=\nabla y = (0,1)^\top=\mathbf{e}_2
\end{displaymath}
This coordinate system is valid only at the outboard midplane for
$\hat{s}\neq0$. If we follow the magnetic field line, the $y$ axis
does not change in the turned coordinate system, but the angle between
$x$ and $y$ axis does change. We name this angle here $\theta_0$. This
also has the consequence, that the covariant and contravariant base
vectors in $x$ direction are not parallel. So the contravariant base
vector $\mathbf{\bar e}^1=\nabla \bar x^1$ is still orthogonal to the
flux surface, but the covariant base vector $\mathbf{\bar e}_1$, which
denotes the coordinate axis direction is not. The transformation of the
contravariant components of a vector from the old Cartesian coordinate system
($x,y$) to the new non-orthogonal $(\bar x,\bar y)$ coordinate system is given by the
following equations.
\begin{eqnarray*}
  \bar x^j\longrightarrow x^j &\qquad& x^1=\bar x^1\sin\theta_0\qquad\qquad
  x^2=\bar x^2 + \bar x^1\cos\theta_0\\
  x^j \longrightarrow \bar x^j &\qquad&  \bar x^1=\frac{x^1}{\sin\theta_0}\qquad\qquad
  \bar x^2 = x^2-\frac{x^1}{\tan\theta_0}
\end{eqnarray*}
For the base vectors in the new system we get
\begin{eqnarray*}
  \mbox{contravariant:}&&\qquad\mathbf{\bar e}^1=\frac{1}{\sin\theta_0}\mathbf{e}^1\qquad
  \mathbf{\bar e}^2=-\frac{1}{\tan\theta_0}\mathbf{e}^1+\mathbf{e}^2\\
  \mbox{covariant:}&&\qquad\mathbf{\bar e}_1=\mathbf{e}_1\sin\theta_0+\mathbf{e}_2\cos\theta_0\qquad
  \mathbf{\bar e}_2=\mathbf{e}_2
\end{eqnarray*}
The metric tensor is given as
\begin{displaymath}
  g^{ij}=\left(
\begin{array}{ll}
  \frac{1}{\sin^2(\theta_0)} & -\frac{\cos\theta_0}{\sin^2(\theta_0)} \\
 -\frac{\cos\theta_0}{\sin^2(\theta_0)} & \frac{1}{\sin^2(\theta_0)}
\end{array}
\right)\qquad
  g_{ij}=\left(
    \begin{array}{cc}
      1 & \cos\theta_0\\
      \cos\theta_0 & 1
    \end{array}\right)
\end{displaymath}


\chapter{B-Splines as base functions}
\label{sec:bsplines}

As base functions on the grid we want to use B-splines. They are
defined by the recurrence relation:
\begin{eqnarray*}
  B_{jk}=\omega_{jk}B_{j,k-1}+(1-\omega_{j+1,k})B_{j+1,k-1}\\
  \mbox{with}\quad\omega_{jk}=\frac{x-t_j}{t_{j+k-1}-t_j}
\end{eqnarray*}
or put together
\begin{eqnarray*}
  B_{jk}=\frac{x-t_j}{t_{j+k-1}-t_j}\,B_{j,k-1}
  +\frac{t_{j+k}-x}{t_{j+k}-t_{j+1}}\,B_{j+1,k-1}
\end{eqnarray*}
and the starting B-spline 
\begin{displaymath}
  B_{j1}=
  \begin{cases}
    1 & x\in[t_j,t_{j+1})\\
    0 & x\notin[t_j,t_{j+1})
  \end{cases}
\end{displaymath}

Therefrom we get for the different orders with the following
calculations the following results.
\begin{eqnarray*}
  B_{j2}&=&\frac{x-t_j}{t_{j+1}-t_j} B_{j,1}
  +\left(1-\frac{x-t_{j+1}}{t_{j+2}-t_{j+1}}\right)B_{j+1,1}\\
  &=&
  \begin{cases}
    \frac{x-t_j}{t_{j+1}-t_j} & x\in[t_j,t_{j+1})\\
    \frac{t_{j+2}-x}{t_{j+2}-t_{j+1}} & x\in[t_{j+1},t_{j+2})\\
    0 & \mbox{else}
  \end{cases}
\end{eqnarray*}
This is exactly the hat function.

The next order gives quadratic (parabolic) B-splines.
\begin{eqnarray*}
  B_{j3}&=&\frac{x-t_j}{t_{j+2}-t_j}\,B_{j,2}
  +\frac{t_{j+3}-x}{t_{j+3}-t_{j+1}}\,B_{j+1,2}\\
  &=&
  \begin{cases}
    \frac{x-t_j}{t_{j+2}-t_j}\,\frac{x-t_j}{t_{j+1}-t_j} & x\in[t_j,t_{j+1})\\
    \frac{x-t_j}{t_{j+2}-t_j}\,\frac{t_{j+2}-x}{t_{j+2}-t_{j+1}}
    +\frac{t_{j+3}-x}{t_{j+3}-t_{j+1}}\,\frac{x-t_{j+1}}{t_{j+2}-t_{j+1}} & x\in[t_{j+1},t_{j+2})\\
    \frac{t_{j+3}-x}{t_{j+3}-t_{j+1}}\,\frac{t_{j+3}-x}{t_{j+3}-t_{j+2}} & x\in[t_{j+2},t_{j+3})\\
    0 & \mbox{else}
  \end{cases}\\
  &=&
  \begin{cases}
    \frac{(x-t_j)^2}{(t_{j+2}-t_j)(t_{j+1}-t_j)} & x\in[t_j,t_{j+1})\\
    \frac{x-t_j}{t_{j+2}-t_j}\,\frac{t_{j+2}-x}{t_{j+2}-t_{j+1}}
    +\frac{t_{j+3}-x}{t_{j+3}-t_{j+1}}\,\frac{x-t_{j+1}}{t_{j+2}-t_{j+1}} & x\in[t_{j+1},t_{j+2})\\
    \frac{(t_{j+3}-x)^2}{(t_{j+3}-t_{j+1})(t_{j+3}-t_{j+2})} & x\in[t_{j+2},t_{j+3})\\
    0 & \mbox{else}
  \end{cases}
\end{eqnarray*}

We want to go one order further to the well-known cubic B-splines. The
above discussed definition leads to
\begin{eqnarray*}
  B_{j4} &=& \frac{x-t_j}{t_{j+3}-t_j}\,B_{j,3}
  +\frac{t_{j+4}-x}{t_{j+4}-t_{j+1}}\,B_{j+1,3}\\
  &=&
  \begin{cases}
    \frac{x-t_j}{t_{j+3}-t_j}\,\frac{(x-t_j)^2}{(t_{j+2}-t_j)(t_{j+1}-t_j)}
    & x\in[t_j,t_{j+1})\\
    % 
    \frac{x-t_j}{t_{j+3}-t_j}\,\left(
      \frac{x-t_j}{t_{j+2}-t_j}\,\frac{t_{j+2}-x}{t_{j+2}-t_{j+1}}
      +\frac{t_{j+3}-x}{t_{j+3}-t_{j+1}}\,\frac{x-t_{j+1}}{t_{j+2}-t_{j+1}}
    \right)
    +\frac{t_{j+4}-x}{t_{j+4}-t_{j+1}}\,\left(
      \frac{(x-t_{j+1})^2}{(t_{j+3}-t_{j+1})(t_{j+2}-t_{j+1})}
    \right) & x\in[t_{j+1},t_{j+2})\\
    % 
    \frac{x-t_j}{t_{j+3}-t_j}\,\left(
      \frac{(t_{j+3}-x)^2}{(t_{j+3}-t_{j+1})(t_{j+3}-t_{j+2})}
    \right)
    +\frac{t_{j+4}-x}{t_{j+4}-t_{j+1}}\,\left(
      \frac{x-t_{j+1}}{t_{j+3}-t_{j+1}}\,\frac{t_{j+3}-x}{t_{j+3}-t_{j+2}}
      +\frac{t_{j+4}-x}{t_{j+4}-t_{j+2}}\,\frac{x-t_{j+2}}{t_{j+3}-t_{j+2}}
  \right)
    & x\in[t_{j+2},t_{j+3})\\
    % 
    \frac{t_{j+4}-x}{t_{j+4}-t_{j+1}}\,\left(
      \frac{(t_{j+4}-x)^2}{(t_{j+4}-t_{j+2})(t_{j+4}-t_{j+3})}
    \right) & x\in[t_{j+3},t_{j+4})\\
    0 & \mbox{else}
  \end{cases}\\
  &=&
  \begin{cases}
    \frac{(x-t_j)^3}{(t_{j+3}-t_j)(t_{j+2}-t_j)(t_{j+1}-t_j)}
    & x\in[t_j,t_{j+1})\\
    % 
    \frac{x-t_j}{t_{j+3}-t_j}\,\left(
      \frac{x-t_j}{t_{j+2}-t_j}\,\frac{t_{j+2}-x}{t_{j+2}-t_{j+1}}
      +\frac{t_{j+3}-x}{t_{j+3}-t_{j+1}}\,\frac{x-t_{j+1}}{t_{j+2}-t_{j+1}}
    \right)
    +\frac{(t_{j+4}-x)(x-t_{j+1})^2}{(t_{j+4}-t_{j+1})(t_{j+3}-t_{j+1})(t_{j+2}-t_{j+1})}
     & x\in[t_{j+1},t_{j+2})\\
    % 
    \frac{(x-t_j)(t_{j+3}-x)^2}{(t_{j+3}-t_j)(t_{j+3}-t_{j+1})(t_{j+3}-t_{j+2})}
    +\frac{t_{j+4}-x}{t_{j+4}-t_{j+1}}\,\left(
      \frac{x-t_{j+1}}{t_{j+3}-t_{j+1}}\,\frac{t_{j+3}-x}{t_{j+3}-t_{j+2}}
      +\frac{t_{j+4}-x}{t_{j+4}-t_{j+2}}\,\frac{x-t_{j+2}}{t_{j+3}-t_{j+2}}
  \right)
    & x\in[t_{j+2},t_{j+3})\\
    % 
    \frac{(t_{j+4}-x)^3}{(t_{j+4}-t_{j+1})(t_{j+4}-t_{j+2})(t_{j+4}-t_{j+3})}
    & x\in[t_{j+3},t_{j+4})\\
    0 & \mbox{else}
  \end{cases}
\end{eqnarray*}
On an equidistant mesh with gridsize $\Delta x$ this can be written as
\begin{eqnarray*}
  B_{j4} &=&
  \begin{cases}
    \frac{(x-t_j)^3}{6\Delta x^3}
    & x\in[t_j,t_{j+1})\\
    % 
    \frac{x-t_j}{6\Delta x^3}\,\left(
      (x-t_j)(t_{j+2}-x)
      +(t_{j+3}-x)(x-t_{j+1})
    \right)
    +\frac{(t_{j+4}-x)(x-t_{j+1})^2}{6\dx^3}
     & x\in[t_{j+1},t_{j+2})\\
    % 
    \frac{(x-t_j)(t_{j+3}-x)^2}{6\dx^3}
    +\frac{t_{j+4}-x}{6\dx^3}\,\left(
      (x-t_{j+1})(t_{j+3}-x)
      +(t_{j+4}-x)(x-t_{j+2})
  \right)
    & x\in[t_{j+2},t_{j+3})\\
    % 
    \frac{(t_{j+4}-x)^3}{6\dx^3}
    & x\in[t_{j+3},t_{j+4})\\
    0 & \mbox{else}
  \end{cases}
\end{eqnarray*}

To calculate the coefficients of a representation of a function in
this basis, one has to solve a linear system of equations. In one
dimension one has on a grid
\begin{eqnarray*}
  f(x_n) = \sum_j \psi_j B_j(x_n)\quad\forall n=1,\ldots,N
\end{eqnarray*}
Or written as a system of equations
\begin{displaymath}
  \mathcal{B}\cdot\mathbf{\psi}=\mathbf{f}=
  \left(
    \begin{array}{ccccc}
      B_1(x_1) & B_2(x_1) & \ldots & B_N(x_1)\\
      B_1(x_2) & \ldots & \ldots & B_N(x_2)\\
      \vdots & \ddots & \ddots & \vdots\\
      B_1(x_N) & \ldots & \ldots & B_N(x_N)
    \end{array}
  \right)\cdot\left(
    \begin{array}{c}
      \psi_1\\\psi_2\\\vdots\\\psi_N
    \end{array}
  \right)
  =\left(
    \begin{array}{c}
      f_1\\f_2\\\vdots\\f_N
    \end{array}
  \right)
\end{displaymath}
The matrix can be evaluated in advance, as we need only the values of
the splines on the grid points. From the definition above we get for a
equidistant mesh
\begin{eqnarray*}
  B_j(t_j) = 0\qquad B_j(t_{j+1})=\frac{1}{6}
  \qquad B_j(t_{j+2}) = \frac{2}{3}\qquad
  B_j(t_{j+3}) = \frac{1}{6}
\end{eqnarray*}
so that we get for the matrix
\begin{displaymath}
  \mathcal{B}=\left(
    \begin{array}{ccccccc}
      0 & \ldots & \ldots & 0 & \frac{1}{6} & \frac{2}{3} & \frac{1}{6}\\
      \frac{1}{6} & 0 & \ldots & \ldots & 0 & \frac{1}{6} & \frac{2}{3} \\
      \frac{2}{3} & \frac{1}{6} & 0 &  \ldots &\ldots & 0 & \frac{1}{6} \\
      \frac{1}{6} & \frac{2}{3} & \frac{1}{6} & 0 & \ldots & \ldots & 0 \\
      0 & \frac{1}{6} & \frac{2}{3} & \frac{1}{6} & 0 & \ldots & 0\\
      \vdots & \ddots & \ddots & \ddots & \ddots & \ddots & \vdots\\
      0 & \ldots & 0 & \frac{1}{6} & \frac{2}{3} & \frac{1}{6} & 0 
    \end{array}
  \right)
\end{displaymath}


In two dimensions the things change. We want to represent the two
dimensions separately, that we get
\begin{displaymath}
  f(x_n,y_m)=\sum_{i,j}\psi_{ij}B_i(x_n)B_j(y_m)
\end{displaymath}
To determine the coefficients, we have to rewrite this equations in
matrix-vector form and then solve the linear system of equations. The
matrix has now the dimension $N\cdot M\times N\cdot M$, for each
point, we have one column and one row. Therefore we can write the
system as
\begin{displaymath}
  \left(
    \begin{array}{ccccccc}
      B_{1,1}(1,1) & B_{2,1}(1,1) & \ldots & B_{N,1}(1,1) &
      B_{1,2}(1,1) & \ldots & B_{N,M}(1,1)\\
      B_{1,1}(2,1) & B_{2,1}(2,1) & \ldots & B_{N,1}(2,1) &
      B_{1,2}(2,1) & \ldots & B_{N,M}(2,1)\\
      \vdots & &&&&& \vdots\\
      B_{1,1}(N,M) & B_{2,1}(N,M) & \ldots & B_{N,1}(N,M) &
      B_{1,2}(N,M) & \ldots & B_{N,M}(N,M)\\
    \end{array}
  \right)\cdot\left(
    \begin{array}{c}
      \psi_{1,1}\\\psi_{2,1}\\\vdots\\\psi_{N,1}\\
      \psi_{1,2}\\\psi_{2,2}\\\vdots\\\psi_{N,2}\\
      \vdots\\
      \psi_{1,M}\\\psi_{2,M}\\\vdots\\\psi_{N,M}
    \end{array}
  \right) = \left(
    \begin{array}{c}
      f_{1,1}\\f_{2,1}\\\vdots\\f_{N,1}\\
      f_{1,2}\\f_{2,2}\\\vdots\\f_{N,2}\\
      \vdots\\
      f_{1,M}\\f_{2,M}\\\vdots\\f_{N,M}
    \end{array}
  \right)
\end{displaymath}
With periodic boundary conditions, we find that in each line of the
matrix, only 9 elements are nonzero. In the first line these are the
elements
\begin{eqnarray*}
  B_{N-2,M-2}=\frac{1}{36}\qquad
  B_{N-1,M-2}=\frac{1}{9}\qquad
  B_{N,M-2} =\frac{1}{36}\\
  B_{N-2,M-1}=\frac{1}{9}\qquad
  B_{N-1,M-1}=\frac{4}{9}\qquad
  B_{N,M-1} =\frac{1}{9}\\
  B_{N-2,M}=\frac{1}{36}\qquad
  B_{N-1,M}=\frac{1}{9}\qquad
  B_{N,M} =\frac{1}{36}
\end{eqnarray*}

\end{document}

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: t
%%% End: 
