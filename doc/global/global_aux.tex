\documentclass[12pt]{article}
\usepackage{amsmath}
%\usepackage[charter]{mathdesign}
\begin{document}
\input{commands}
\section{Energetics}
The bilinear form
$$E[g_1,g_2]=\sum_{s,k}\int d\lambda \frac{nTh_1^*g_2}{F_0},$$
($\sum_{s,k}$ is the sum over species and Fourier modes, $\int d\lambda$ is the integral over the 
remaining phase space, and $h=g+q/T F_0(\bar \Phi-v_\parallel \bar A_\parallel)$, $T=T(x,s)$ has a radial 
depencence in the global case, but $n=n(s)$ is radially constant since it is only a result of the gene 
normalization) defines the positive semidefinite fluctuation entropy $E[g,g]$ a.k.a. free energy a.k.a. 
energy of a state vector $g$. $E[g_1,g_2]$ is always real due to the sum over all (positive and negative) 
Fourier modes and the reality condition for all quantities, e.g. $g(-k)=g(k)^*$.\\

\subsection{Free energy and stability}
If no sources (drive, Krook heating..) and no sinks 
(collisions, hyperdiffusions, Krook terms..) are present, this quantity is analytically 
conserved by the linear and nonlinear 
gyrokinetic equation.  If this property is preserved 
by the numerical scheme, the (source/sink-free) simulation has to be stable. (We will focus on
this source/sink-free case in the following, the positive/negative definiteness of 
sources/sinks is another topic which has to be addressed once this is solved..).\\
If the (energy conserving) change of $g$ in one time step is $\Delta g$, 
i.e. $g_{n+1}=g_n+\Delta g$, the corresponding energy increment is 
$$\Delta E=E[g_{n+1},g_{n+1}]-E[g_n,g_n]=E[g_n,\Delta g]+E[\Delta g,g_n]+E[\Delta g,\Delta g].$$
For small $\Delta g$ (which corresponds to small $\Delta t$) the last term can be neglected, 
so that the condition 
$$E[g,\Delta g]+E[\Delta g,g]=0$$ (the $n$ index has been dropped, i.e. $g=g_n$) 
guarantees a numerically stable scheme.\\
We have $\Delta g=(T_1+T_2+T_3+..)\Delta t+\mathcal{O}(\Delta t^2)$, where the 
$T_i$ are the different (energy conserving) terms of the RHS of the gyrokinetic equation 
(trapping/parallel advection terms, nonlinearity, curvature terms maybe). For $\Delta t<<1$,
this leads to the condition for stability
$$E[g,T_i]+E[T_i,g]=0$$ for all $i$.
While it is possible to devise discretization schemes for the $T_i$ to have $E[g,T_i]=0$, 
(e.g. Arakawa differencing if $T_i$ can be written as Poisson bracket in $h$), it is in general 
difficult (if not impossible) to satisfy $E[T_i,g]=0$ simultaneously.
This problem is solved trivially if the (numerical representation of) $E$ has the symmetry $E[g,T_i]=E[T_i,g]$.\\

\subsection{Gyroaverging operations on distribution functions and fields}
The gyrokinetic equation system as given in \cite{Goerler09},
contains two types of gyroaveraging operations, which differ in the
position at which the gyroaveraged quantity is evaluated. 
For the gyroaverages occurring in the Vlasov equation, the 
function to be averaged is evaluated at the particle position 
$\vec X+\vec r$. On the other hand, one has to compute moments of the
distribution function, which contain gyroaverages for which
the function is evaluated at the gyrocenter position $\vec X=\vec x-\vec r$.

As we will see in the following sections, when written in terms of
finite element basis functions, the first of these operations will 
involve a gyromatrix $\Gop$, while the second involves its adjunct 
$\dg\Gop$.

In terms of a finite element basis $\{\Lambda_n(x)\}$, an arbitrary
function $\Phi(x)$ can be written as
\begin{align}
\Phi(x)=\suml_n \Lambda_n(x) \Phi(x_n),
\end{align}
where the sum over $n$ denotes the sum over all gridpoints in $x$.
We now calculate the gyroaverage of a such a function at a gyrocenter
position $X_i$ on the radial grid, which yields
\begin{align}
\nonumber\gyav{\Phi}(\vec X_i)=\gyav{\Phi(\vec X_i+\vec r)}=
\otp\intl_0^{2\pi}\Phi(\pp)\dga=\\
\otp\suml_{k_y,n}\Phi(x_n,k_y,z)\e^{\imag k_y Y}\intl_0^{2\pi}\Lambda_n(X_i+r^1)
\e^{\imag k_yr^2}\dga.
\label{eq:G}
\end{align}
Employing a matrix-vector multiplication, we can represent the previous
expression as
\begin{align}
\gyav{\Phi(\vec X_i+\vec r)}=\suml_{k_y}\e^{\imag k_y Y}\Gop\cdot\mathbf\Phi,
\end{align}
where $\Gop$ is a matrix connecting values of $\Phi$ on gridpoints $x_n$
to gyroaveraged values on gridpoints $X_i$ (suppressing the $y$ and $z$ 
directions here) and $\mathbf\Phi=(\Phi(x_1,k_y,z),\dots,\Phi(x_{N_x},k_y,z))^T$.

Now we repeat this calculation for the gyroaverage that appears when 
evaluating moments. Here, we are interested in a moment of the distribution
function at gridpoint $(x_i,y,z)$.
Since the moment is calculated in terms of a distribution which is given in
gyrocenter coordinates, we have to transform to particle coordinates, which, 
neglecting the Jacobian and effects from the pull-back for clarity, can be 
expressed as
\begin{align}
M(\vec x_i)=\suml_{k_y}\int\e^{\imag k_yY}\delta(X+r^1-x_i)\delta(Y+r^2-y)
F_1(X,k_y,z)\dop X\dop Y\dga.
\end{align} 
We evaluate the $\dop Y$ integral to get
\begin{align}
M(\vec x_i)=\suml_{k_y}\e^{\imag k_yy}\int\e^{-\imag k_yr^2}\delta(X+r^1-x_i)F_1(X,k_y,z)\dop X\dga.
\end{align}
The delta function can be represented on the discrete radial grid as
$\delta(X+r^1-x_i)=\suml_n\Lambda_n(X+r^1)\Lambda_n(x_i)=\Lambda_i(X+r^1)$.
Finally, we switch from an integral over $\dop X$ to a discrete sum over 
$X_n$, resulting in
\begin{align}
M(\vec x_i)=\suml_{k_y,n}F_1(X_n,k_y,z)\e^{\imag k_yy}\int\Lambda_i(X_n+r^1)\e^{-\imag k_yr^2}\dga.
\end{align}
By comparison with Eq.~\ref{eq:G}, this can then be written as
\begin{align}
M(\vec x)=\suml_{k_y}\e^{\imag k_yy}\dg\Gop\cdot\vec F_1,
\end{align}
where $\dg\Gop=\bar{\Gop}^T$.

\subsection{Symmetry of the free energy bilinear form}
With the definition of $h$, $E[g_1,g_2]$ can be decomposed into
\begin{align}
E[g_1,g_2]&=\sum_{s,k}\int d\lambda (\frac{nT}{F_0} g_1^*+qn\bar \Phi_1^*-qnv_\parallel\bar A_\parallel^*) g_2\nonumber\\
&=\sum_{s,k}\int d\lambda \;\frac{nT}{F_0}g_1^* g_2+\sum_{s,k}\int d\lambda\; qn \bar \Phi_1^* g_2
-\sum_{s,k}\int d\lambda\; qn v_\parallel\bar A_{\parallel,1}^* g_2\nonumber\\
&=E_1[g_1,g_2]+E_2[g_1,g_2]+E_3[g_1,g_2].
\end{align}
In order to have $E[g_1,g_2]=E[g_2,g_1]$, all $E_i$ have to be symmetric in the arguments.
Since the $E_i$ are real, the first term obviously is symmetric.\\
The second and third terms are more complicated. After discretization, $E_2$ can be written as
$$E_2[g_1,g_2]=\vec g_1^\dag\cdot\vec M\cdot \vec g_2,$$ 
where $\vec g$ is a column vector, $\vec g ^\dag$ the Hermitian adjoint vector 
(i.e. complex conjugate transposed), $M$ a square matrix, and $\cdot$ is the standard 
matrix-vector product.\\
The requirement $E_2[g_1,g_2]=E_2[g_2,g_1]$ is equivalent to the requirement $M^\dag=M$, 
i.e. the Hermiticity of $M$. The matrix $M$ is a combination of operations which can all be
represented by matrices.
The physically (3,6)-dimensional, numerically (nx0*ny0*nz0,nx0*ny0*nz0*nv0*nw0*ns0)-dimensional 
operator to compute the 3D charge density of a 6D state vector is
$$\vec D_Q=\vec I_s \cdot\vec 1_{qn}\cdot \vec I_\mu \cdot \vec W_\mu \cdot\Gop^\dag\cdot \vec I_{v_\parallel}\cdot \vec W_{v_\parallel} \cdot \vec J_v$$
where $\vec J_v=\vec J_v(x,z,v_\parallel)$, $\vec 1_{qn}=\vec 1_{qn}(s)$, $\vec W_\mu=\vec W_\mu(\mu)$, 
$\vec W_{v_\parallel}=\vec W_{v_\parallel}(v_\parallel)$ are real, square, and diagonal 
(i.e. Hermitian) matrices of the velocity space Jacobian, the $q*n$ factors, and the weights 
for the integrations respectively. 
The dimensions of the operators that are missing for the required dimensionality are given by an outer 
product with the unit matrix, e.g. 
$\vec W_{v_\parallel}=\vec W_{v_\parallel}(v_\parallel)\otimes \vec 1_{x,y,z,w,s}$. The
$\vec I_d$ are the (n-1,n)-dimensional summation matrices that contract the dimension $d$ and leave the 
other dimensions untouched, and $\Gop$ is the 5D square gyroaveraging operator.\\
The field operator $\vec F_{es}$, which computes $\Phi$ from the charge density (i.e. $\Phi=\vec F_{es}\cdot \vec D_Q \cdot \vec g$),  is a 3D square matrix. 
To compute the 5D gyroaverage of the 3D field, expansion matrices in the $\mu$ and s direction 
have to be introduced. These turn out ot be the transposes (Hermitian adjoints) of the $\vec I_{\mu}$ 
and $\vec I_{s}$ operators introduced above. The gyroaveraged field is then
$$\bar \Phi_1=\Gop\cdot \vec I_{\mu}^\dag \cdot\vec I_{s}^\dag\cdot\vec F_{es}\cdot \vec D_Q \cdot \vec g_1,$$
so that $M$ can be written as
$$\vec M=\vec D_Q^\dag\cdot\vec F_{es}^\dag\cdot\vec I_{s} \cdot \vec I_{\mu} \cdot\Gop^\dag \cdot \vec J_{xyz}\cdot \vec W_{xyz}\cdot \vec W_\mu  \cdot\vec 1_{qn}\cdot \vec I_{v_\parallel}\cdot \vec W_{v_\parallel}\cdot \vec J_v$$
with $\vec J_{xyz}=\vec J_{xyz}(x,z)$ the (diagonal) spatial Jacobian and $\vec W_{xyz}$ the spatial 
weights (constant in GENE).\\
Operators with an x dependence don't commute with $\Gop^\dag$, and operators with a dependence 
on dimension $d$ don't commute with $I_d$, everything else commutes (most operators are diagonal anyway).\\
With this, $M$ can be written as
$$\vec M= \vec D_Q^\dag\cdot\vec F_{es}^\dag\cdot\vec D_Q\cdot\vec J_{xyz}.$$
If $[\vec D_Q^\dag\cdot\vec F_{es}^\dag\cdot\vec D_Q,\vec J_{xyz}]=0$, the condition $E_2[g_1,g_2]=E_2[g_2,g_1]$ 
becomes equivalent to $\vec F_{es}^\dag=\vec F_{es}$, both conditions are trivially fulfilled for the local 
code ($\vec F_{es}$ is real and diagonal).\\
For the $E_3$ term, the derivation is exactly the same, except that the charge density operator $D_Q$ is replaced by the
current density operator 
$$D_I=\vec I_s \cdot\vec 1_{qn}\cdot \vec I_\mu \cdot \vec W_\mu \cdot\Gop^\dag\cdot \vec I_{v_\parallel}\cdot \vec W_{v_\parallel} \cdot \vec J_v \cdot \vec 1_{v_T}\cdot \vec 1_{v_\parallel}$$
with $\vec 1_{v_T}=\vec 1_{v_T}(s)$ the thermal velocity from the normalization and $\vec 1_{v_\parallel}=\vec 1_{v_\parallel}(v_\parallel)$,
and $F_{es}$ is replaced by $F_{em}$.

\subsection{Hermiticity of the field operators (incl. BCs)}
When taking into account the contributions from the gyrocenter pull-back 
operator, consecutive gyroaverages have to be evaluated. This can be easily
expressed by the two relations derived above. For a single $k_y$ mode,
the consecutive gyroaverages are then given by
\begin{align}
\gyav{\bar{\Phi}(x_i-r^1,k_y,z)}=\dg\Gop\Gop\mathbf\Phi
\end{align}


\subsection{Term-by-term conservation of the free energy}



\subsection{Other conserved quantities in nonlocal gyrokinetics}


\end{document}
